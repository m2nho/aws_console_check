<!-- EC2 섹션 -->
<div class="card mb-4 service-section" id="ec2-section">
    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#ec2-content" aria-expanded="true">
        <h5 class="mb-0">
            <i class="fas fa-server me-2"></i> {{ services.ec2.name }}
        </h5>
        <span class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
        </span>
    </div>
    <div class="collapse show" id="ec2-content">
        <div class="card-body">
            {% if all_services_data.ec2.error is defined %}
                <div class="alert alert-danger">{{ all_services_data.ec2.error }}</div>
            {% elif all_services_data.ec2.instances|default([])|length > 0 %}
                <!-- EC2 Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">총 인스턴스</h5>
                                <p class="card-text display-6">{{ all_services_data.ec2.instances|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">실행 중</h5>
                                <p class="card-text display-6">{{ all_services_data.ec2.instances|selectattr('state', 'equalto', 'running')|list|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <h5 class="card-title">중지됨</h5>
                                <p class="card-text display-6">{{ all_services_data.ec2.instances|selectattr('state', 'equalto', 'stopped')|list|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">인스턴스 타입</h5>
                                <p class="card-text">{{ all_services_data.ec2.instances|map(attribute='type')|list|unique|list|length }} 종류</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sortable">
                        <thead>
                            <tr>
                                <th>인스턴스 ID</th>
                                <th>인스턴스 유형</th>
                                <th>상태</th>
                                <th>가용 영역</th>
                                <th>위험도</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for instance in all_services_data.ec2.instances %}
                            <tr>
                                <td>{{ instance.id }}</td>
                                <td>{{ instance.type }}</td>
                                <td>
                                    {% if instance.state == 'running' %}
                                        <span class="badge bg-success">실행 중</span>
                                    {% elif instance.state == 'stopped' %}
                                        <span class="badge bg-danger">중지됨</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ instance.state }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ instance.az }}</td>
                                <td>
                                    {% set rec_key = 'ec2:' ~ instance.id %}
                                    {% if resource_recommendations[rec_key] is defined %}
                                        <span class="badge bg-{{ 'danger' if resource_recommendations[rec_key].severity == '높음' else 'warning' if resource_recommendations[rec_key].severity == '중간' else 'info' }}">{{ resource_recommendations[rec_key].severity }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">없음</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary toggle-details" data-bs-toggle="collapse" data-bs-target="#details-ec2-{{ loop.index }}">
                                            <i class="fas fa-chevron-down me-1"></i> 세부 작업 보기
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="details-row">
                                <td colspan="6" class="p-0">
                                    <div class="collapse" id="details-ec2-{{ loop.index }}">
                                        <div class="card card-body bg-light border-0 p-3 m-2">
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-server me-2"></i>인스턴스 정보</h6>
                                                <p class="mb-1"><strong>인스턴스 ID:</strong> {{ instance.id }}</p>
                                                <p class="mb-1"><strong>인스턴스 유형:</strong> {{ instance.type }}</p>
                                                <p class="mb-1"><strong>가용 영역:</strong> {{ instance.az }}</p>
                                                <p class="mb-0"><strong>상태:</strong> 
                                                    {% if instance.state == 'running' %}
                                                        <span class="badge bg-success">실행 중</span>
                                                    {% elif instance.state == 'stopped' %}
                                                        <span class="badge bg-danger">중지됨</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ instance.state }}</span>
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>문제점
                                                </h6>
                                                <p class="mb-0">
                                                    {% if instance.state == 'stopped' %}
                                                        EC2 인스턴스 {{ instance.id }}가 중지된 상태로 유지되고 있습니다.
                                                    {% else %}
                                                        EC2 인스턴스 {{ instance.id }}가 {{ instance.type }} 타입으로 실행 중입니다. 이 타입이 워크로드에 최적화되지 않을 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-chart-line me-2"></i>영향</h6>
                                                <p class="mb-0">
                                                    {% if instance.state == 'stopped' %}
                                                        중지된 인스턴스는 스토리지 비용이 계속 발생하며, 필요하지 않은 리소스를 차지합니다.
                                                    {% else %}
                                                        인스턴스 타입이 워크로드에 최적화되지 않으면 성능 저하나 불필요한 비용이 발생할 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-tasks me-2"></i>권장 조치</h6>
                                                <ol class="ps-3 mb-0">
                                                    {% if instance.state == 'stopped' %}
                                                        <li class="mb-1">AWS 콘솔에서 EC2 서비스로 이동합니다.</li>
                                                        <li class="mb-1">인스턴스 {{ instance.id }}를 선택합니다.</li>
                                                        <li class="mb-1">필요하지 않은 경우 '인스턴스 종료' 작업을 수행합니다.</li>
                                                        <li class="mb-1">필요한 경우 AMI를 생성하여 나중에 복원할 수 있도록 합니다.</li>
                                                    {% else %}
                                                        <li class="mb-1">CloudWatch 지표를 확인하여 현재 인스턴스의 CPU, 메모리, 네트워크 사용량을 분석합니다.</li>
                                                        <li class="mb-1">AWS Compute Optimizer 권장 사항을 확인합니다.</li>
                                                        <li class="mb-1">워크로드에 적합한 인스턴스 타입으로 변경을 계획합니다.</li>
                                                        <li class="mb-1">인스턴스를 중지하고 인스턴스 타입을 변경한 후 다시 시작합니다.</li>
                                                    {% endif %}
                                                </ol>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-check-circle me-2"></i>기대 효과</h6>
                                                <p class="mb-0">
                                                    {% if instance.state == 'stopped' %}
                                                        불필요한 EC2 인스턴스를 종료하면 월별 AWS 비용을 절감할 수 있습니다.
                                                    {% else %}
                                                        적절한 인스턴스 타입을 선택하면 성능을 향상시키고 비용을 최적화할 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div>
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-link me-2"></i>관련 링크</h6>
                                                <ul class="ps-3 mb-0">
                                                    {% if instance.state == 'stopped' %}
                                                        <li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/terminating-instances.html" target="_blank">EC2 인스턴스 종료 가이드</a></li>
                                                    {% else %}
                                                        <li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-resize.html" target="_blank">EC2 인스턴스 크기 조정 가이드</a></li>
                                                        <li><a href="https://aws.amazon.com/compute-optimizer/" target="_blank">AWS Compute Optimizer</a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">EC2 인스턴스가 없습니다.</div>
            {% endif %}
        </div>
    </div>
</div>