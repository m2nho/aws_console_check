{% extends "base.html" %}

{% block title %}통합 대시보드 - AWS 콘솔 체크{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item active">통합 대시보드</li>
    </ol>
</nav>

<h1 class="mb-4">AWS 서비스 통합 대시보드</h1>
<p class="lead">모든 AWS 서비스의 정보를 한 페이지에서 확인하세요.</p>

<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <button class="btn btn-primary" id="expand-all">모두 펼치기</button>
            <button class="btn btn-outline-secondary ms-2" id="collapse-all">모두 접기</button>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
            <label class="form-check-label" for="auto-refresh">자동 새로고침 (30초)</label>
        </div>
    </div>
</div>

<!-- EC2 섹션 -->
<div class="card mb-4 service-section" id="ec2-section">
    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#ec2-content" aria-expanded="true">
        <h5 class="mb-0">
            <i class="fas fa-server me-2"></i> {{ services.ec2.name }}
        </h5>
        <span class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
        </span>
    </div>
    <div class="collapse show" id="ec2-content">
        <div class="card-body">
            {% if all_services_data.ec2.error is defined %}
                <div class="alert alert-danger">{{ all_services_data.ec2.error }}</div>
            {% elif all_services_data.ec2.instances|default([])|length > 0 %}
                <!-- EC2 Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">총 인스턴스</h5>
                                <p class="card-text display-6">{{ all_services_data.ec2.instances|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">실행 중</h5>
                                <p class="card-text display-6">{{ all_services_data.ec2.instances|selectattr('state', 'equalto', 'running')|list|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <h5 class="card-title">중지됨</h5>
                                <p class="card-text display-6">{{ all_services_data.ec2.instances|selectattr('state', 'equalto', 'stopped')|list|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">인스턴스 타입</h5>
                                <p class="card-text">{{ all_services_data.ec2.instances|map(attribute='type')|list|unique|list|length }} 종류</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sortable">
                        <thead>
                            <tr>
                                <th>인스턴스 ID</th>
                                <th>인스턴스 유형</th>
                                <th>상태</th>
                                <th>가용 영역</th>
                                <th>위험도</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for instance in all_services_data.ec2.instances %}
                            <tr>
                                <td>{{ instance.id }}</td>
                                <td>{{ instance.type }}</td>
                                <td>
                                    {% if instance.state == 'running' %}
                                        <span class="badge bg-success">실행 중</span>
                                    {% elif instance.state == 'stopped' %}
                                        <span class="badge bg-danger">중지됨</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ instance.state }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ instance.az }}</td>
                                <td>
                                    {% set rec_key = 'ec2:' ~ instance.id %}
                                    {% if resource_recommendations[rec_key] is defined %}
                                        <span class="badge bg-{{ 'danger' if resource_recommendations[rec_key].severity == '높음' else 'warning' if resource_recommendations[rec_key].severity == '중간' else 'info' }}">{{ resource_recommendations[rec_key].severity }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">없음</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary toggle-details" data-bs-toggle="collapse" data-bs-target="#details-ec2-{{ loop.index }}">
                                            <i class="fas fa-chevron-down me-1"></i> 세부 작업 보기
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="details-row">
                                <td colspan="6" class="p-0">
                                    <div class="collapse" id="details-ec2-{{ loop.index }}">
                                        <div class="card card-body bg-light border-0 p-3 m-2">
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-server me-2"></i>인스턴스 정보</h6>
                                                <p class="mb-1"><strong>인스턴스 ID:</strong> {{ instance.id }}</p>
                                                <p class="mb-1"><strong>인스턴스 유형:</strong> {{ instance.type }}</p>
                                                <p class="mb-1"><strong>가용 영역:</strong> {{ instance.az }}</p>
                                                <p class="mb-0"><strong>상태:</strong> 
                                                    {% if instance.state == 'running' %}
                                                        <span class="badge bg-success">실행 중</span>
                                                    {% elif instance.state == 'stopped' %}
                                                        <span class="badge bg-danger">중지됨</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ instance.state }}</span>
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>문제점
                                                </h6>
                                                <p class="mb-0">
                                                    {% if instance.state == 'stopped' %}
                                                        EC2 인스턴스 {{ instance.id }}가 중지된 상태로 유지되고 있습니다.
                                                    {% else %}
                                                        EC2 인스턴스 {{ instance.id }}가 {{ instance.type }} 타입으로 실행 중입니다. 이 타입이 워크로드에 최적화되지 않을 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-chart-line me-2"></i>영향</h6>
                                                <p class="mb-0">
                                                    {% if instance.state == 'stopped' %}
                                                        중지된 인스턴스는 스토리지 비용이 계속 발생하며, 필요하지 않은 리소스를 차지합니다.
                                                    {% else %}
                                                        인스턴스 타입이 워크로드에 최적화되지 않으면 성능 저하나 불필요한 비용이 발생할 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-tasks me-2"></i>권장 조치</h6>
                                                <ol class="ps-3 mb-0">
                                                    {% if instance.state == 'stopped' %}
                                                        <li class="mb-1">AWS 콘솔에서 EC2 서비스로 이동합니다.</li>
                                                        <li class="mb-1">인스턴스 {{ instance.id }}를 선택합니다.</li>
                                                        <li class="mb-1">필요하지 않은 경우 '인스턴스 종료' 작업을 수행합니다.</li>
                                                        <li class="mb-1">필요한 경우 AMI를 생성하여 나중에 복원할 수 있도록 합니다.</li>
                                                    {% else %}
                                                        <li class="mb-1">CloudWatch 지표를 확인하여 현재 인스턴스의 CPU, 메모리, 네트워크 사용량을 분석합니다.</li>
                                                        <li class="mb-1">AWS Compute Optimizer 권장 사항을 확인합니다.</li>
                                                        <li class="mb-1">워크로드에 적합한 인스턴스 타입으로 변경을 계획합니다.</li>
                                                        <li class="mb-1">인스턴스를 중지하고 인스턴스 타입을 변경한 후 다시 시작합니다.</li>
                                                    {% endif %}
                                                </ol>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-check-circle me-2"></i>기대 효과</h6>
                                                <p class="mb-0">
                                                    {% if instance.state == 'stopped' %}
                                                        불필요한 EC2 인스턴스를 종료하면 월별 AWS 비용을 절감할 수 있습니다.
                                                    {% else %}
                                                        적절한 인스턴스 타입을 선택하면 성능을 향상시키고 비용을 최적화할 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div>
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-link me-2"></i>관련 링크</h6>
                                                <ul class="ps-3 mb-0">
                                                    {% if instance.state == 'stopped' %}
                                                        <li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/terminating-instances.html" target="_blank">EC2 인스턴스 종료 가이드</a></li>
                                                    {% else %}
                                                        <li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-resize.html" target="_blank">EC2 인스턴스 크기 조정 가이드</a></li>
                                                        <li><a href="https://aws.amazon.com/compute-optimizer/" target="_blank">AWS Compute Optimizer</a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">EC2 인스턴스가 없습니다.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- S3 섹션 -->
<div class="card mb-4 service-section" id="s3-section">
    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#s3-content" aria-expanded="true">
        <h5 class="mb-0">
            <i class="fas fa-database me-2"></i> {{ services.s3.name }}
        </h5>
        <span class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
        </span>
    </div>
    <div class="collapse show" id="s3-content">
        <div class="card-body">
            {% if all_services_data.s3.error is defined %}
                <div class="alert alert-danger">{{ all_services_data.s3.error }}</div>
            {% elif all_services_data.s3.buckets|default([])|length > 0 %}
                <!-- S3 Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">총 버킷</h5>
                                <p class="card-text display-6">{{ all_services_data.s3.buckets|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">최근 생성</h5>
                                <p class="card-text">{{ all_services_data.s3.buckets|sort(attribute='creation_date')|reverse|first|attr('creation_date') }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">가장 오래된 버킷</h5>
                                <p class="card-text">{{ all_services_data.s3.buckets|sort(attribute='creation_date')|first|attr('creation_date') }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sortable">
                        <thead>
                            <tr>
                                <th>버킷 이름</th>
                                <th>생성일</th>
                                <th>위험도</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bucket in all_services_data.s3.buckets %}
                            <tr>
                                <td>{{ bucket.name }}</td>
                                <td>{{ bucket.creation_date }}</td>
                                <td>
                                    {% set rec_key = 's3:' ~ bucket.name %}
                                    {% if resource_recommendations[rec_key] is defined %}
                                        <span class="badge bg-{{ 'danger' if resource_recommendations[rec_key].severity == '높음' else 'warning' if resource_recommendations[rec_key].severity == '중간' else 'info' }}">{{ resource_recommendations[rec_key].severity }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">없음</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary toggle-details" data-bs-toggle="collapse" data-bs-target="#details-s3-{{ loop.index }}">
                                            <i class="fas fa-chevron-down me-1"></i> 세부 작업 보기
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="details-row">
                                <td colspan="5" class="p-0">
                                    <div class="collapse" id="details-s3-{{ loop.index }}">
                                        <div class="card card-body bg-light border-0 p-3 m-2">
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-database me-2"></i>버킷 정보</h6>
                                                <p class="mb-1"><strong>버킷 이름:</strong> {{ bucket.name }}</p>
                                                <p class="mb-0"><strong>생성일:</strong> {{ bucket.creation_date }}</p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>문제점
                                                </h6>
                                                <p class="mb-0">S3 버킷 {{ bucket.name }}에 수명 주기 규칙이 설정되어 있지 않을 수 있습니다.</p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-chart-line me-2"></i>영향</h6>
                                                <p class="mb-0">수명 주기 규칙이 없으면 오래된 객체가 자동으로 저비용 스토리지 클래스로 이동하거나 삭제되지 않아 불필요한 비용이 발생할 수 있습니다.</p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-tasks me-2"></i>권장 조치</h6>
                                                <ol class="ps-3 mb-0">
                                                    <li class="mb-1">AWS 콘솔에서 S3 서비스로 이동합니다.</li>
                                                    <li class="mb-1">버킷 {{ bucket.name }}을 선택합니다.</li>
                                                    <li class="mb-1">'관리' 탭을 클릭합니다.</li>
                                                    <li class="mb-1">'수명 주기 규칙'에서 '규칙 생성'을 클릭합니다.</li>
                                                    <li class="mb-1">객체의 사용 패턴에 따라 적절한 전환 및 만료 규칙을 설정합니다.</li>
                                                </ol>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-check-circle me-2"></i>기대 효과</h6>
                                                <p class="mb-0">수명 주기 규칙을 설정하면 자주 액세스하지 않는 객체를 자동으로 저비용 스토리지 클래스로 이동하거나 불필요한 객체를 삭제하여 스토리지 비용을 절감할 수 있습니다.</p>
                                            </div>
                                            
                                            <div>
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-link me-2"></i>관련 링크</h6>
                                                <ul class="ps-3 mb-0">
                                                    <li><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/lifecycle-configuration-examples.html" target="_blank">S3 수명 주기 구성 예제</a></li>
                                                    <li><a href="https://aws.amazon.com/blogs/aws/amazon-s3-object-lifecycle-management/" target="_blank">S3 객체 수명 주기 관리 블로그</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">S3 버킷이 없습니다.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- RDS 섹션 -->
<div class="card mb-4 service-section" id="rds-section">
    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#rds-content" aria-expanded="true">
        <h5 class="mb-0">
            <i class="fas fa-database me-2"></i> {{ services.rds.name }}
        </h5>
        <span class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
        </span>
    </div>
    <div class="collapse show" id="rds-content">
        <div class="card-body">
            {% if all_services_data.rds.error is defined %}
                <div class="alert alert-danger">{{ all_services_data.rds.error }}</div>
            {% elif all_services_data.rds.instances|default([])|length > 0 %}
                <!-- RDS Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">총 인스턴스</h5>
                                <p class="card-text display-6">{{ all_services_data.rds.instances|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">사용 가능</h5>
                                <p class="card-text display-6">{{ all_services_data.rds.instances|selectattr('status', 'equalto', 'available')|list|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">엔진 종류</h5>
                                <p class="card-text">{{ all_services_data.rds.instances|map(attribute='engine')|list|unique|list|length }} 종류</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body">
                                <h5 class="card-title">인스턴스 클래스</h5>
                                <p class="card-text">{{ all_services_data.rds.instances|map(attribute='size')|list|unique|list|length }} 종류</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sortable">
                        <thead>
                            <tr>
                                <th>인스턴스 ID</th>
                                <th>엔진</th>
                                <th>상태</th>
                                <th>인스턴스 클래스</th>
                                <th>위험도</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for instance in all_services_data.rds.instances %}
                            <tr>
                                <td>{{ instance.id }}</td>
                                <td>{{ instance.engine }}</td>
                                <td>
                                    {% if instance.status == 'available' %}
                                        <span class="badge bg-success">사용 가능</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ instance.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ instance.size }}</td>
                                <td>
                                    {% set rec_key = 'rds:' ~ instance.id %}
                                    {% if resource_recommendations[rec_key] is defined %}
                                        <span class="badge bg-{{ 'danger' if resource_recommendations[rec_key].severity == '높음' else 'warning' if resource_recommendations[rec_key].severity == '중간' else 'info' }}">{{ resource_recommendations[rec_key].severity }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">없음</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary toggle-details" data-bs-toggle="collapse" data-bs-target="#details-rds-{{ loop.index }}">
                                            <i class="fas fa-chevron-down me-1"></i> 세부 작업 보기
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="details-row">
                                <td colspan="6" class="p-0">
                                    <div class="collapse" id="details-rds-{{ loop.index }}">
                                        <div class="card card-body bg-light border-0 p-3 m-2">
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-database me-2"></i>데이터베이스 정보</h6>
                                                <p class="mb-1"><strong>인스턴스 ID:</strong> {{ instance.id }}</p>
                                                <p class="mb-1"><strong>엔진:</strong> {{ instance.engine }}</p>
                                                <p class="mb-1"><strong>인스턴스 클래스:</strong> {{ instance.size }}</p>
                                                <p class="mb-0"><strong>상태:</strong> 
                                                    {% if instance.status == 'available' %}
                                                        <span class="badge bg-success">사용 가능</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ instance.status }}</span>
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>문제점
                                                </h6>
                                                <p class="mb-0">
                                                    {% if not instance.id.startswith('aurora-') %}
                                                        RDS 인스턴스 {{ instance.id }}가 Aurora가 아닌 {{ instance.engine }} 엔진을 사용하고 있습니다.
                                                    {% else %}
                                                        RDS 인스턴스 {{ instance.id }}의 백업 및 고가용성 설정이 최적화되지 않았을 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-chart-line me-2"></i>영향</h6>
                                                <p class="mb-0">
                                                    {% if not instance.id.startswith('aurora-') %}
                                                        Aurora는 기존 MySQL 및 PostgreSQL 데이터베이스보다 최대 5배 향상된 성능과 향상된 가용성을 제공합니다.
                                                    {% else %}
                                                        적절한 백업 및 고가용성 설정이 없으면 데이터 손실 위험이 증가하고 장애 발생 시 복구 시간이 길어질 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-tasks me-2"></i>권장 조치</h6>
                                                <ol class="ps-3 mb-0">
                                                    {% if not instance.id.startswith('aurora-') %}
                                                        <li class="mb-1">AWS 콘솔에서 RDS 서비스로 이동합니다.</li>
                                                        <li class="mb-1">스냅샷을 생성하여 현재 데이터베이스를 백업합니다.</li>
                                                        <li class="mb-1">스냅샷에서 Aurora 데이터베이스로 복원합니다.</li>
                                                        <li class="mb-1">애플리케이션 연결 문자열을 새 Aurora 엔드포인트로 업데이트합니다.</li>
                                                        <li class="mb-1">마이그레이션이 완료되면 원본 RDS 인스턴스를 삭제합니다.</li>
                                                    {% else %}
                                                        <li class="mb-1">자동 백업이 활성화되어 있고 적절한 보존 기간이 설정되어 있는지 확인합니다.</li>
                                                        <li class="mb-1">다중 AZ 배포를 설정하여 고가용성을 확보합니다.</li>
                                                        <li class="mb-1">데이터베이스 인스턴스와 스냅샷이 암호화되어 있는지 확인합니다.</li>
                                                    {% endif %}
                                                </ol>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-check-circle me-2"></i>기대 효과</h6>
                                                <p class="mb-0">
                                                    {% if not instance.id.startswith('aurora-') %}
                                                        Aurora로 마이그레이션하면 성능이 향상되고, 자동 확장 기능을 활용할 수 있으며, 운영 오버헤드가 감소합니다.
                                                    {% else %}
                                                        적절한 백업 및 고가용성 설정을 통해 데이터 보호를 강화하고 서비스 중단 시간을 최소화할 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div>
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-link me-2"></i>관련 링크</h6>
                                                <ul class="ps-3 mb-0">
                                                    {% if not instance.id.startswith('aurora-') %}
                                                        <li><a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Aurora.Migrating.html" target="_blank">Aurora로 마이그레이션 가이드</a></li>
                                                        <li><a href="https://aws.amazon.com/rds/aurora/" target="_blank">Amazon Aurora 소개</a></li>
                                                    {% else %}
                                                        <li><a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithAutomatedBackups.html" target="_blank">RDS 백업 및 복원</a></li>
                                                        <li><a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.MultiAZ.html" target="_blank">RDS 다중 AZ 배포</a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">RDS 인스턴스가 없습니다.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Lambda 섹션 -->
<div class="card mb-4 service-section" id="lambda-section">
    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#lambda-content" aria-expanded="true">
        <h5 class="mb-0">
            <i class="fas fa-code me-2"></i> {{ services.lambda.name }}
        </h5>
        <span class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
        </span>
    </div>
    <div class="collapse show" id="lambda-content">
        <div class="card-body">
            {% if all_services_data.lambda.error is defined %}
                <div class="alert alert-danger">{{ all_services_data.lambda.error }}</div>
            {% elif all_services_data.lambda.functions|default([])|length > 0 %}
                <!-- Lambda Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">총 함수</h5>
                                <p class="card-text display-6">{{ all_services_data.lambda.functions|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">런타임 종류</h5>
                                <p class="card-text">{{ all_services_data.lambda.functions|map(attribute='runtime')|list|unique|list|length }} 종류</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body">
                                <h5 class="card-title">평균 메모리</h5>
                                <p class="card-text">{{ (all_services_data.lambda.functions|sum(attribute='memory') / all_services_data.lambda.functions|length)|round|int }} MB</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <h5 class="card-title">최대 타임아웃</h5>
                                <p class="card-text">{{ all_services_data.lambda.functions|max(attribute='timeout')|attr('timeout') }} 초</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sortable">
                        <thead>
                            <tr>
                                <th>함수 이름</th>
                                <th>런타임</th>
                                <th>메모리 (MB)</th>
                                <th>타임아웃 (초)</th>
                                <th>위험도</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for function in all_services_data.lambda.functions %}
                            <tr>
                                <td>{{ function.name }}</td>
                                <td>{{ function.runtime }}</td>
                                <td>{{ function.memory }}</td>
                                <td>{{ function.timeout }}</td>
                                <td>
                                    {% set rec_key = 'lambda:' ~ function.name %}
                                    {% if resource_recommendations[rec_key] is defined %}
                                        <span class="badge bg-{{ 'danger' if resource_recommendations[rec_key].severity == '높음' else 'warning' if resource_recommendations[rec_key].severity == '중간' else 'info' }}">{{ resource_recommendations[rec_key].severity }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">없음</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary toggle-details" data-bs-toggle="collapse" data-bs-target="#details-lambda-{{ loop.index }}">
                                            <i class="fas fa-chevron-down me-1"></i> 세부 작업 보기
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="details-row">
                                <td colspan="6" class="p-0">
                                    <div class="collapse" id="details-lambda-{{ loop.index }}">
                                        <div class="card card-body bg-light border-0 p-3 m-2">
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-code me-2"></i>함수 정보</h6>
                                                <p class="mb-1"><strong>함수 이름:</strong> {{ function.name }}</p>
                                                <p class="mb-1"><strong>런타임:</strong> {{ function.runtime }}</p>
                                                <p class="mb-1"><strong>메모리:</strong> {{ function.memory }} MB</p>
                                                <p class="mb-0"><strong>타임아웃:</strong> {{ function.timeout }} 초</p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>문제점
                                                </h6>
                                                <p class="mb-0">
                                                    {% if function.memory > 512 %}
                                                        Lambda 함수 {{ function.name }}의 메모리가 {{ function.memory }}MB로 설정되어 있어 필요 이상으로 높을 수 있습니다.
                                                    {% elif function.timeout > 60 %}
                                                        Lambda 함수 {{ function.name }}의 타임아웃이 {{ function.timeout }}초로 설정되어 있어 장시간 실행되는 작업에 사용되고 있을 수 있습니다.
                                                    {% else %}
                                                        Lambda 함수 {{ function.name }}의 설정이 최적화되지 않았을 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-chart-line me-2"></i>영향</h6>
                                                <p class="mb-0">
                                                    {% if function.memory > 512 %}
                                                        Lambda 함수에 할당된 메모리가 필요 이상으로 높으면 불필요한 비용이 발생합니다.
                                                    {% elif function.timeout > 60 %}
                                                        Lambda는 단기 실행 작업에 최적화되어 있으며, 장시간 실행되는 작업은 비용이 증가하고 타임아웃 위험이 있습니다.
                                                    {% else %}
                                                        Lambda 함수의 설정이 최적화되지 않으면 성능 저하나 불필요한 비용이 발생할 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-tasks me-2"></i>권장 조치</h6>
                                                <ol class="ps-3 mb-0">
                                                    {% if function.memory > 512 %}
                                                        <li class="mb-1">CloudWatch Logs에서 함수의 실제 메모리 사용량을 확인합니다.</li>
                                                        <li class="mb-1">AWS Lambda 콘솔에서 함수 구성을 편집합니다.</li>
                                                        <li class="mb-1">메모리 할당을 실제 사용량에 맞게 조정합니다.</li>
                                                        <li class="mb-1">변경 후 함수 성능을 모니터링하여 문제가 없는지 확인합니다.</li>
                                                    {% elif function.timeout > 60 %}
                                                        <li class="mb-1">함수의 실행 시간을 CloudWatch Logs에서 확인합니다.</li>
                                                        <li class="mb-1">실행 시간이 길다면 작업을 더 작은 단위로 분할하는 것을 고려합니다.</li>
                                                        <li class="mb-1">장시간 실행되는 작업은 Step Functions, Batch, ECS 등의 서비스로 마이그레이션을 고려합니다.</li>
                                                        <li class="mb-1">함수 코드를 최적화하여 실행 시간을 단축합니다.</li>
                                                    {% else %}
                                                        <li class="mb-1">CloudWatch Logs에서 함수의 실제 메모리 사용량과 실행 시간을 확인합니다.</li>
                                                        <li class="mb-1">함수의 실행 역할이 최소 권한 원칙을 따르는지 확인합니다.</li>
                                                        <li class="mb-1">X-Ray를 활성화하여 함수 성능을 분석합니다.</li>
                                                    {% endif %}
                                                </ol>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-check-circle me-2"></i>기대 효과</h6>
                                                <p class="mb-0">
                                                    {% if function.memory > 512 %}
                                                        Lambda 함수의 메모리 할당을 최적화하면 비용을 절감하면서도 필요한 성능을 유지할 수 있습니다.
                                                    {% elif function.timeout > 60 %}
                                                        적절한 서비스를 사용하면 비용을 절감하고, 안정성을 향상시키며, 관리 오버헤드를 줄일 수 있습니다.
                                                    {% else %}
                                                        Lambda 함수 설정을 최적화하면 성능을 향상시키고 비용을 절감할 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div>
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-link me-2"></i>관련 링크</h6>
                                                <ul class="ps-3 mb-0">
                                                    {% if function.memory > 512 %}
                                                        <li><a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-memory.html" target="_blank">Lambda 함수 메모리 구성</a></li>
                                                        <li><a href="https://aws.amazon.com/blogs/compute/operating-lambda-performance-optimization-part-1/" target="_blank">Lambda 성능 최적화 가이드</a></li>
                                                    {% elif function.timeout > 60 %}
                                                        <li><a href="https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html" target="_blank">Lambda 모범 사례</a></li>
                                                        <li><a href="https://aws.amazon.com/step-functions/" target="_blank">AWS Step Functions 소개</a></li>
                                                    {% else %}
                                                        <li><a href="https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html" target="_blank">Lambda 모범 사례</a></li>
                                                        <li><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-x-ray.html" target="_blank">Lambda와 X-Ray 통합</a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">Lambda 함수가 없습니다.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- CloudWatch 섹션 -->
<div class="card mb-4 service-section" id="cloudwatch-section">
    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#cloudwatch-content" aria-expanded="true">
        <h5 class="mb-0">
            <i class="fas fa-chart-line me-2"></i> {{ services.cloudwatch.name }}
        </h5>
        <span class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
        </span>
    </div>
    <div class="collapse show" id="cloudwatch-content">
        <div class="card-body">
            {% if all_services_data.cloudwatch.error is defined %}
                <div class="alert alert-danger">{{ all_services_data.cloudwatch.error }}</div>
            {% elif all_services_data.cloudwatch.alarms|default([])|length > 0 %}
                <!-- CloudWatch Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">총 경보</h5>
                                <p class="card-text display-6">{{ all_services_data.cloudwatch.alarms|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">정상 상태</h5>
                                <p class="card-text display-6">{{ all_services_data.cloudwatch.alarms|selectattr('state', 'equalto', 'OK')|list|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <h5 class="card-title">경보 상태</h5>
                                <p class="card-text display-6">{{ all_services_data.cloudwatch.alarms|selectattr('state', 'equalto', 'ALARM')|list|length }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sortable">
                        <thead>
                            <tr>
                                <th>경보 이름</th>
                                <th>상태</th>
                                <th>지표</th>
                                <th>위험도</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alarm in all_services_data.cloudwatch.alarms %}
                            <tr>
                                <td>{{ alarm.name }}</td>
                                <td>
                                    {% if alarm.state == 'OK' %}
                                        <span class="badge bg-success">정상</span>
                                    {% elif alarm.state == 'ALARM' %}
                                        <span class="badge bg-danger">경보</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ alarm.state }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ alarm.metric }}</td>
                                <td>
                                    {% set rec_key = 'cloudwatch:' ~ alarm.name %}
                                    {% if resource_recommendations[rec_key] is defined %}
                                        <span class="badge bg-{{ 'danger' if resource_recommendations[rec_key].severity == '높음' else 'warning' if resource_recommendations[rec_key].severity == '중간' else 'info' }}">{{ resource_recommendations[rec_key].severity }}</span>
                                    {% elif alarm.state == 'ALARM' %}
                                        <span class="badge bg-danger">높음</span>
                                    {% else %}
                                        <span class="badge bg-secondary">없음</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary toggle-details" data-bs-toggle="collapse" data-bs-target="#details-cloudwatch-{{ loop.index }}">
                                            <i class="fas fa-chevron-down me-1"></i> 세부 작업 보기
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="details-row">
                                <td colspan="5" class="p-0">
                                    <div class="collapse" id="details-cloudwatch-{{ loop.index }}">
                                        <div class="card card-body bg-light border-0 p-3 m-2">
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-chart-line me-2"></i>경보 정보</h6>
                                                <p class="mb-1"><strong>경보 이름:</strong> {{ alarm.name }}</p>
                                                <p class="mb-1"><strong>지표:</strong> {{ alarm.metric }}</p>
                                                <p class="mb-0"><strong>상태:</strong> 
                                                    {% if alarm.state == 'OK' %}
                                                        <span class="badge bg-success">정상</span>
                                                    {% elif alarm.state == 'ALARM' %}
                                                        <span class="badge bg-danger">경보</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ alarm.state }}</span>
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>문제점
                                                </h6>
                                                <p class="mb-0">
                                                    {% if alarm.state == 'ALARM' %}
                                                        CloudWatch 경보 {{ alarm.name }}가 현재 경보 상태입니다.
                                                    {% else %}
                                                        CloudWatch 경보 설정이 최적화되지 않았을 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-chart-line me-2"></i>영향</h6>
                                                <p class="mb-0">
                                                    {% if alarm.state == 'ALARM' %}
                                                        경보 상태는 모니터링 중인 리소스에 문제가 있음을 나타내며, 즉시 조사하지 않으면 서비스 중단이나 성능 저하가 발생할 수 있습니다.
                                                    {% else %}
                                                        경보 설정이 최적화되지 않으면 중요한 문제를 감지하지 못하거나 불필요한 알림이 발생할 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-tasks me-2"></i>권장 조치</h6>
                                                <ol class="ps-3 mb-0">
                                                    {% if alarm.state == 'ALARM' %}
                                                        <li class="mb-1">AWS 콘솔에서 CloudWatch 서비스로 이동합니다.</li>
                                                        <li class="mb-1">경보 {{ alarm.name }}를 선택합니다.</li>
                                                        <li class="mb-1">경보 세부 정보를 확인하여 문제의 원인을 파악합니다.</li>
                                                        <li class="mb-1">관련 리소스를 확인하고 필요한 조치를 취합니다.</li>
                                                        <li class="mb-1">문제가 해결되면 경보가 자동으로 정상 상태로 돌아가는지 확인합니다.</li>
                                                    {% else %}
                                                        <li class="mb-1">경보 임계값이 워크로드에 적합한지 주기적으로 검토합니다.</li>
                                                        <li class="mb-1">경보 알림이 적절한 대상(이메일, SMS, 자동화 등)으로 설정되어 있는지 확인합니다.</li>
                                                        <li class="mb-1">여러 조건을 조합한 복합 경보를 활용하여 오탐을 줄입니다.</li>
                                                        <li class="mb-1">중요한 리소스에 대한 추가 경보를 설정합니다.</li>
                                                    {% endif %}
                                                </ol>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-check-circle me-2"></i>기대 효과</h6>
                                                <p class="mb-0">
                                                    {% if alarm.state == 'ALARM' %}
                                                        경보 상태의 원인을 신속하게 해결하면 서비스 중단을 최소화하고 성능 문제를 해결할 수 있습니다.
                                                    {% else %}
                                                        적절한 경보 설정을 통해 문제를 조기에 감지하고 대응하여 서비스 가용성과 성능을 향상시킬 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div>
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-link me-2"></i>관련 링크</h6>
                                                <ul class="ps-3 mb-0">
                                                    {% if alarm.state == 'ALARM' %}
                                                        <li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html" target="_blank">CloudWatch 경보 문제 해결</a></li>
                                                    {% else %}
                                                        <li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html" target="_blank">CloudWatch 경보 생성 가이드</a></li>
                                                        <li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Create_Composite_Alarm.html" target="_blank">복합 경보 생성</a></li>
                                                    {% endif %}
                                                    <li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/cloudwatch_concepts.html" target="_blank">CloudWatch 개념</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">CloudWatch 경보가 없습니다.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- IAM 섹션 -->
<div class="card mb-4 service-section" id="iam-section">
    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#iam-content" aria-expanded="true">
        <h5 class="mb-0">
            <i class="fas fa-users-cog me-2"></i> {{ services.iam.name }}
        </h5>
        <span class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
        </span>
    </div>
    <div class="collapse show" id="iam-content">
        <div class="card-body">
            {% if all_services_data.iam.error is defined %}
                <div class="alert alert-danger">{{ all_services_data.iam.error }}</div>
            {% elif all_services_data.iam.users|default([])|length > 0 %}
                <!-- IAM Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">총 사용자</h5>
                                <p class="card-text display-6">{{ all_services_data.iam.users|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card {% if all_services_data.iam.users|length > 5 %}bg-warning text-dark{% else %}bg-success text-white{% endif %}">
                            <div class="card-body">
                                <h5 class="card-title">보안 상태</h5>
                                <p class="card-text">
                                    {% if all_services_data.iam.users|length > 5 %}
                                        <i class="fas fa-exclamation-triangle"></i> 사용자가 5명 이상입니다. 미사용 계정을 검토하세요.
                                    {% else %}
                                        <i class="fas fa-check-circle"></i> 사용자 수가 적절합니다.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sortable">
                        <thead>
                            <tr>
                                <th>사용자 이름</th>
                                <th>생성일</th>
                                <th>위험도</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in all_services_data.iam.users %}
                            <tr>
                                <td>{{ user.name }}</td>
                                <td>{{ user.created }}</td>
                                <td>
                                    {% set rec_key = 'iam:' ~ user.name %}
                                    {% if resource_recommendations[rec_key] is defined %}
                                        <span class="badge bg-{{ 'danger' if resource_recommendations[rec_key].severity == '높음' else 'warning' if resource_recommendations[rec_key].severity == '중간' else 'info' }}">{{ resource_recommendations[rec_key].severity }}</span>
                                    {% elif all_services_data.iam.users|length > 5 %}
                                        <span class="badge bg-danger">높음</span>
                                    {% else %}
                                        <span class="badge bg-secondary">없음</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary toggle-details" data-bs-toggle="collapse" data-bs-target="#details-iam-{{ loop.index }}">
                                            <i class="fas fa-chevron-down me-1"></i> 세부 작업 보기
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="details-row">
                                <td colspan="4" class="p-0">
                                    <div class="collapse" id="details-iam-{{ loop.index }}">
                                        <div class="card card-body bg-light border-0 p-3 m-2">
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-users-cog me-2"></i>사용자 정보</h6>
                                                <p class="mb-1"><strong>사용자 이름:</strong> {{ user.name }}</p>
                                                <p class="mb-1"><strong>사용자 ID:</strong> {{ user.id }}</p>
                                                <p class="mb-0"><strong>생성일:</strong> {{ user.created }}</p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>문제점
                                                </h6>
                                                <p class="mb-0">
                                                    IAM 사용자 {{ user.name }}의 보안 설정이 최적화되지 않았을 수 있습니다.
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-chart-line me-2"></i>영향</h6>
                                                <p class="mb-0">
                                                    IAM 사용자의 보안 설정이 최적화되지 않으면 계정 침해 위험이 증가하고, 불필요한 권한으로 인해 보안 취약점이 발생할 수 있습니다.
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-tasks me-2"></i>권장 조치</h6>
                                                <ol class="ps-3 mb-0">
                                                    <li class="mb-1">사용자에게 MFA를 활성화합니다.</li>
                                                    <li class="mb-1">액세스 키를 정기적으로 교체합니다.</li>
                                                    <li class="mb-1">최소 권한 원칙을 적용하여 필요한 권한만 부여합니다.</li>
                                                    <li class="mb-1">장기간 사용하지 않은 자격 증명이 있는지 확인하고 제거합니다.</li>
                                                    <li class="mb-1">가능한 경우 개별 IAM 사용자 대신 IAM 역할과 페더레이션을 사용합니다.</li>
                                                </ol>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-check-circle me-2"></i>기대 효과</h6>
                                                <p class="mb-0">
                                                    IAM 사용자의 보안 설정을 최적화하면 계정 침해 위험을 줄이고, 최소 권한 원칙을 적용하여 보안 태세를 강화할 수 있습니다.
                                                </p>
                                            </div>
                                            
                                            <div>
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-link me-2"></i>관련 링크</h6>
                                                <ul class="ps-3 mb-0">
                                                    <li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html" target="_blank">IAM 사용자에 대한 MFA 활성화</a></li>
                                                    <li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html" target="_blank">액세스 키 관리</a></li>
                                                    <li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html" target="_blank">IAM 모범 사례</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">IAM 사용자가 없습니다.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- DynamoDB 섹션 -->
<div class="card mb-4 service-section" id="dynamodb-section">
    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#dynamodb-content" aria-expanded="true">
        <h5 class="mb-0">
            <i class="fas fa-table me-2"></i> {{ services.dynamodb.name }}
        </h5>
        <span class="toggle-icon">
            <i class="fas fa-chevron-down"></i>
        </span>
    </div>
    <div class="collapse show" id="dynamodb-content">
        <div class="card-body">
            {% if all_services_data.dynamodb.error is defined %}
                <div class="alert alert-danger">{{ all_services_data.dynamodb.error }}</div>
            {% elif all_services_data.dynamodb.tables|default([])|length > 0 %}
                <!-- DynamoDB Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">총 테이블</h5>
                                <p class="card-text display-6">{{ all_services_data.dynamodb.tables|length }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">총 항목 수</h5>
                                <p class="card-text display-6">{{ all_services_data.dynamodb.tables|sum(attribute='items')|int }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">총 크기</h5>
                                <p class="card-text">{{ (all_services_data.dynamodb.tables|sum(attribute='size')|round(2)) }} MB</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sortable">
                        <thead>
                            <tr>
                                <th>테이블 이름</th>
                                <th>상태</th>
                                <th>항목 수</th>
                                <th>크기 (MB)</th>
                                <th>위험도</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for table in all_services_data.dynamodb.tables %}
                            <tr>
                                <td>{{ table.name }}</td>
                                <td>
                                    {% if table.status == 'ACTIVE' %}
                                        <span class="badge bg-success">활성</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ table.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ table.items }}</td>
                                <td>{{ table.size|round(2) }}</td>
                                <td>
                                    {% set rec_key = 'dynamodb:' ~ table.name %}
                                    {% if resource_recommendations[rec_key] is defined %}
                                        <span class="badge bg-{{ 'danger' if resource_recommendations[rec_key].severity == '높음' else 'warning' if resource_recommendations[rec_key].severity == '중간' else 'info' }}">{{ resource_recommendations[rec_key].severity }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">없음</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary toggle-details" data-bs-toggle="collapse" data-bs-target="#details-dynamodb-{{ loop.index }}">
                                            <i class="fas fa-chevron-down me-1"></i> 세부 작업 보기
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="details-row">
                                <td colspan="6" class="p-0">
                                    <div class="collapse" id="details-dynamodb-{{ loop.index }}">
                                        <div class="card card-body bg-light border-0 p-3 m-2">
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-table me-2"></i>테이블 정보</h6>
                                                <p class="mb-1"><strong>테이블 이름:</strong> {{ table.name }}</p>
                                                <p class="mb-1"><strong>상태:</strong> {{ table.status }}</p>
                                                <p class="mb-1"><strong>항목 수:</strong> {{ table.items }}</p>
                                                <p class="mb-0"><strong>크기:</strong> {{ table.size|round(2) }} MB</p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>문제점
                                                </h6>
                                                <p class="mb-0">
                                                    {% if table.items > 1000000 %}
                                                        DynamoDB 테이블 {{ table.name }}에 많은 항목({{ table.items }}개)이 있습니다.
                                                    {% else %}
                                                        DynamoDB 테이블 {{ table.name }}의 설정이 최적화되지 않았을 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-chart-line me-2"></i>영향</h6>
                                                <p class="mb-0">
                                                    {% if table.items > 1000000 %}
                                                        테이블에 항목이 많으면 쿼리 성능이 저하되고 비용이 증가할 수 있습니다.
                                                    {% else %}
                                                        DynamoDB 테이블 설정이 최적화되지 않으면 성능 저하나 불필요한 비용이 발생할 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-tasks me-2"></i>권장 조치</h6>
                                                <ol class="ps-3 mb-0">
                                                    {% if table.items > 1000000 %}
                                                        <li class="mb-1">파티셔닝 전략을 검토하고 필요한 경우 테이블을 여러 개로 분할합니다.</li>
                                                        <li class="mb-1">인덱스 사용을 최적화하여 쿼리 성능을 향상시킵니다.</li>
                                                        <li class="mb-1">오래된 데이터를 아카이브하거나 삭제하는 전략을 구현합니다.</li>
                                                        <li class="mb-1">Auto Scaling 설정을 검토하여 필요에 따라 용량을 조정합니다.</li>
                                                    {% else %}
                                                        <li class="mb-1">프로비저닝된 용량 모드와 온디맨드 용량 모드 중 워크로드에 적합한 모드를 선택합니다.</li>
                                                        <li class="mb-1">인덱스 사용을 최적화하여 쿼리 성능을 향상시킵니다.</li>
                                                        <li class="mb-1">TTL(Time to Live) 설정을 활용하여 오래된 데이터를 자동으로 삭제합니다.</li>
                                                        <li class="mb-1">DAX(DynamoDB Accelerator)를 고려하여 읽기 성능을 향상시킵니다.</li>
                                                    {% endif %}
                                                </ol>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-check-circle me-2"></i>기대 효과</h6>
                                                <p class="mb-0">
                                                    {% if table.items > 1000000 %}
                                                        적절한 파티셔닝과 인덱싱을 통해 쿼리 성능을 향상시키고 비용을 최적화할 수 있습니다.
                                                    {% else %}
                                                        DynamoDB 설정을 최적화하면 성능을 향상시키고 비용을 절감할 수 있습니다.
                                                    {% endif %}
                                                </p>
                                            </div>
                                            
                                            <div>
                                                <h6 class="fw-bold text-muted mb-2"><i class="fas fa-link me-2"></i>관련 링크</h6>
                                                <ul class="ps-3 mb-0">
                                                    <li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-partition-key-design.html" target="_blank">DynamoDB 파티션 키 설계</a></li>
                                                    <li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-indexes.html" target="_blank">DynamoDB 인덱스 모범 사례</a></li>
                                                    <li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/AutoScaling.html" target="_blank">DynamoDB Auto Scaling</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">DynamoDB 테이블이 없습니다.</div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    #last-refresh {
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Make tables sortable
        const tables = document.querySelectorAll('.table-sortable');
        if (tables) {
            tables.forEach(table => {
                const headers = table.querySelectorAll('th');
                headers.forEach((header, index) => {
                    header.addEventListener('click', function() {
                        sortTable(table, index);
                    });
                    header.title = '클릭하여 정렬';
                });
            });
        }
        
        // Function to sort tables
        function sortTable(table, column) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const direction = table.getAttribute('data-sort-direction') === 'asc' ? -1 : 1;
            
            // Sort the rows
            rows.sort((a, b) => {
                const aValue = a.querySelectorAll('td')[column].textContent.trim();
                const bValue = b.querySelectorAll('td')[column].textContent.trim();
                
                if (!isNaN(aValue) && !isNaN(bValue)) {
                    return direction * (Number(aValue) - Number(bValue));
                } else {
                    return direction * aValue.localeCompare(bValue, 'ko');
                }
            });
            
            // Update the table
            rows.forEach(row => tbody.appendChild(row));
            
            // Toggle the sort direction
            table.setAttribute('data-sort-direction', direction === 1 ? 'asc' : 'desc');
        }
        
        // Handle expand/collapse all buttons
        const expandAllBtn = document.getElementById('expand-all');
        const collapseAllBtn = document.getElementById('collapse-all');
        
        if (expandAllBtn) {
            expandAllBtn.addEventListener('click', function() {
                document.querySelectorAll('.service-section .collapse').forEach(section => {
                    const bsCollapse = new bootstrap.Collapse(section, { toggle: false });
                    bsCollapse.show();
                });
            });
        }
        
        if (collapseAllBtn) {
            collapseAllBtn.addEventListener('click', function() {
                document.querySelectorAll('.service-section .collapse').forEach(section => {
                    const bsCollapse = new bootstrap.Collapse(section, { toggle: false });
                    bsCollapse.hide();
                });
            });
        }
        
        // Handle refresh button
        const refreshBtn = document.getElementById('refresh-data');
        const lastRefreshSpan = document.getElementById('last-refresh');
        
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                // Add spinning animation to the refresh icon
                const refreshIcon = refreshBtn.querySelector('i');
                refreshIcon.classList.add('refreshing');
                
                // Disable the button during refresh
                refreshBtn.disabled = true;
                
                // Reload the page
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            });
        }
        
        // Auto refresh functionality
        const autoRefreshToggle = document.getElementById('auto-refresh');
        let refreshInterval;
        
        if (autoRefreshToggle) {
            // Initialize auto refresh based on the toggle state
            if (autoRefreshToggle.checked) {
                startAutoRefresh();
            }
            
            // Toggle auto refresh on change
            autoRefreshToggle.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
        }
        
        function startAutoRefresh() {
            // Clear any existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Set new interval (30 seconds)
            refreshInterval = setInterval(() => {
                // Update the last refresh time
                updateLastRefreshTime();
                
                // Add spinning animation to the refresh icon
                const refreshIcon = refreshBtn.querySelector('i');
                refreshIcon.classList.add('refreshing');
                
                // Reload the page
                window.location.reload();
            }, 30000);
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // Update the last refresh time
        function updateLastRefreshTime() {
            if (lastRefreshSpan) {
                lastRefreshSpan.textContent = '마지막 업데이트: 방금 전';
            }
        }
        
        // Update the last refresh time every minute
        setInterval(() => {
            if (lastRefreshSpan && lastRefreshSpan.textContent === '마지막 업데이트: 방금 전') {
                lastRefreshSpan.textContent = '마지막 업데이트: 1분 전';
            } else if (lastRefreshSpan) {
                const currentText = lastRefreshSpan.textContent;
                const minutes = parseInt(currentText.match(/\d+/)[0]);
                lastRefreshSpan.textContent = `마지막 업데이트: ${minutes + 1}분 전`;
            }
        }, 60000);
    });
</script>
{% endblock %}

